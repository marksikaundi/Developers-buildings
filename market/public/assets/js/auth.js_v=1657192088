$(document).ready(function () {
    console.log('Changes are effecting');
    jQuery.getScript("/market/public/assets/js/jquery.validate.min.js", function () {
        $("#loginForm").validate({
            rules: {
                user_email: {
                    required: true,
                    email: true,
                    maxlength: 100
                },
                user_password: {
                    required: true,
                    minlength: 4,
                    maxlength: 18
                }
            },
            submitHandler: function (form) {
                return false;
            }
        });
        $("#signupForm").validate({
            rules: {
                textRegName: {
                    required: true,
                    maxlength: 100,
                    validate_name: true,
                },
                textSRegEmail: {
                    required: true,
                    email: true,
                    maxlength: 100,
                }
            }
        });
        $("#fromChekOtp").validate({
            rules: {
                txtValidateOTP: {
                    required: true,
                    minlength: 6,
                    maxlength: 6,
                }
            },
            messages: {
                txtValidateOTP: {
                    minlength: "OTP should be 6 characters",
                    maxlength: "OTP should be 6 characters",
                },
            }
        });
        $("#formConfirmPassword").validate({ // form 4
            rules: {
                textSRegPwd: {
                    required: true,
                    minlength: 6,
                    maxlength: 18
                },
                textRegRePwd: {
                    required: true,
                    minlength: 6,
                    equalTo: "#textSRegPwd"
                },
            },
            messages: {
                textRegRePwd: {
                    equalTo: "Confirm password should same as new password"
                },
            }
        });
        $("#formForgetPassword").validate({ //form5
            rules: {
                txtForgotEmailId: {
                    required: true,
                    email: true,
                    maxlength: 100,
                },
            },
        });
        $("#formForgetPasswordOTP").validate({ // form6
            rules: {
                txtForgotOTP: {
                    required: true,
                    minlength: 6,
                    maxlength: 6,
                },
            },
            messages: {
                txtForgotOTP: {
                    minlength: "OTP should be 6 characters",
                    maxlength: "OTP should be 6 characters",
                },
            }
        });
        $("#formForgetPswdNewPswd").validate({ //form7
            rules: {
                txtNewPassword: {
                    required: true,
                    minlength: 6,
                    maxlength: 18
                     
                },
                txtConfirmPassword: {
                    required: true,
                    minlength: 6,
                    maxlength: 18,
                    equalTo: "#txtNewPassword"
                }
            },
            messages: {
                txtConfirmPassword: {
                    equalTo: "Confirm password should same as new password"
                },
            }
        });
        jQuery.validator.addMethod("validate_name", function (value, element) {
            return this.optional(element) || /^[a-zA-Z0-9 ]+$/i.test(value);
        }, "Name can have have only letters and numbers");
    });
});


// Check if already set 
let visit =0;
checkIfVisited();

function checkIfVisited(){
    visit = localStorage.getItem('isVisited');
    if(visit==1){
        $.post('login.jsp',function(response){
            window.location.href = response.redirect_url;
        })
        .fail(function(){
            console.log('User not active');
        });
    }
}

// social login js start
$(document).ready(function () {
    startApp();
//Load the Javascript SDk 
    (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
            return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = "https://connect.facebook.net/en_GB/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    $("#btnFacebookLogin").on('click', function () {
        //do the login
        FB.login(function (response) {
            if (response.authResponse) {
                getUserData();
            }
        }, {scope: 'email,public_profile', return_scopes: true});
    });

    $("#btnGoogleLogin").on('click', function () {
        startApp();
    });
});

function getUserData() {
    FB.api("/me?fields=id,name,email,first_name,last_name,link,locale", function (response) {
        //console.log(response);
        if (response.email != '') {
            SocialAuthorize('facebook', response);
        } else {
            alert("There are some issue in Facebook Response email address.");
        }
    });
}

window.fbAsyncInit = function () {
    //SDK loaded, initialize it 
    FB.init({
        appId: "463399405609127",
        cookie     : true,
        status     : true,
        xfbml      : true,
        version    : 'v3.3'
    });
    //check user session and refresh it
    FB.getLoginStatus(function (response) {
        if (response.status === 'conected') {
            //user is authorized 
        }
    });
};

var auth2;
var startApp = function () {
    gapi.load('auth2', function () {
        // Retrieve the singleton for the GoogleAuth library and set up the client.
        auth2 = gapi.auth2.init({
            client_id: '934794922040-uhm0visbsvgk33aipstahdspovr172ic.apps.googleusercontent.com',
            cookiepolicy: 'single_host_origin',
            scope: 'profile'
                    // Request scopes in addition to 'profile' and 'email'
                    //scope: 'additional_scope'
        });
        attachSignin(document.getElementById('btnGoogleLogin'));
    });
};
// Google Social Qries 
var googleUser = {};
function attachSignin(element) {
    var response = new Object();
    auth2.attachClickHandler(element, {},
        function (googleUser) {
            var googleProfile = googleUser.getBasicProfile();
            response.id = googleProfile.getId();
            response.name = googleProfile.getName();
            response.given_name = googleProfile.getGivenName();
            response.family_name = googleProfile.getFamilyName();
            response.email = googleProfile.getEmail();
            response.image_url = googleProfile.getImageUrl();
            //console.log(response);
            if (response.email != '') {
                SocialAuthorize('google', response);;
            } else {
                alert("There are some issue in Google Response email address.");
            }
        },
        function (error) {
            console.log(error);
            if(error.error=='popup_closed_by_user'){
                toastr.error('You need to enable Third-party cookies in Crome if not enabled.');
            }
        }
    );
}
// social login end

$(document).on('click', '.close_btn', function () {
    window.location.href = '../index.htm'
})
$(document).on('click', '.togglePassword', function () {
    // toggle the type attribute
    var passwordId = $(this).parents('div:first').find('input').attr('id');
    const type = $("#" + passwordId).attr('type') === 'password' ? 'text' : 'password';
    $("#" + passwordId).attr('type', type);

    // toggle the eye slash icon
    $(this).find('svg').toggleClass('fa-eye fa-eye-slash');
});
// Login
$(document).on("click", "#user_login", function () {
    var user_email = $("#user_email").val();
    var user_password = $("#user_password").val();
    var remember_me = 0;
    if ($('#remember_me').prop('checked') === true) {
        remember_me = 1;
    }
    authorize(user_email, user_password, remember_me);
});

// SignUp
$(document).on("click", "#signUp", function () {
    // var name = $("#textSRegEmail").val(); //|| name.includes('online'),  || name.includes('hd')
    // if (name.includes('watch') || name.includes('free') || name.includes('movies') || name.includes('movie')) {
    //     toastr.error('Invalid user name entered');
    //     return false;
    // }
    var textSRegEmail = $("#textSRegEmail").val();
    // if (!$('#signupForm').valid()) {
    //     return false;
    // }
    generateOTP(textSRegEmail, 0);
});
$(document).on("click", "#dup-signUp", function () {
    // var name = $("#textSRegEmail").val();
    // if (name.includes('watch') || name.includes('free') || name.includes('movies') || name.includes('movie')) {
    //     toastr.error('Invalid user name entered');
    //     return false;
    // }
    var textSRegEmail = $("#textSRegEmail").val();
    // if (!$('#signupForm').valid()) {
    //     return false;
    // }
    dupgenerateOTP(textSRegEmail, 0);
});
$(document).on("click", "#validateOtp", function () {
    var txtInputOTP = $("#txtValidateOTP").val();
    var textSRegEmail = $("#textSRegEmail").val();
    if (!$('#fromCheckOtp').valid()) {
        return false;
    }
    validateOTP(txtInputOTP, textSRegEmail);
});

$(document).on("click", "#submitRegister", function () {
    var textRegName = $("#textRegName").val();
    var txtValidateOTP = $("#txtValidateOTP").val();
    var textSRegEmail = $("#textSRegEmail").val();
    var textSRegPwd = $("#textSRegPwd").val();
    var userType = $("#user_type").val();
    var mailSubsription = 0;
    if ($("#chkPromotionalEmail").prop('checked') == true) {
        mailSubsription = 1;
    }
    if (!$('#formConfirmPassword').valid()) {
        return false;
    }
    submitUserDetails(txtValidateOTP, textSRegEmail, textSRegPwd, textRegName, mailSubsription, userType);
});

// Change Passcode
$(document).on("click", "#forgot_pwd", function () {
    var inputEmail = $("#txtForgotEmailId").val();
    if (!$('#formForgetPassword').valid()) {
        return false;
    }
    $('.wrap_loader').show();

    generateOTP(inputEmail, 1);
});
$(document).on("click", "#submit_otp", function () {
    var email = $("#txtForgotEmailId").val();
    var otp = $("#txtForgotOTP").val();
    if (!$('#formForgetPasswordOTP').valid()) {
        return false;
    }
    validateOTP(otp, email, 1);
});

var timeStamp = Date.now || function() {
    return +new Date;
  };
  
$(document).on("click", "#change_password", function () {
    var user_email = $("#txtForgotEmailId").val();
    var secret_code = $("#txtForgotOTP").val();
    var newpass = $("#txtNewPassword").val();
    if (!$('#formForgetPswdNewPswd').valid()) {
        return false;
    }
    $.ajax({
        type: 'POST',
        url: 'changeForgotPassword.jsp?v=' + timeStamp(),
        dataType: 'JSON',
        cache: false,
        headers: { 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content') },
        data: {
            "secret_code": secret_code,
            "email_id": user_email,
            "newpass": newpass,
            "type": "forget"
        },
        beforeSend: function () {
            $('.wrap_loader').show();
        },
        success: function (data) {
            $('.wrap_loader').hide();
            $(this).prop("disabled",true);
            toastr.success(data.message);
            setTimeout(function(){
                $(this).prop("disabled",false);
                window.location.href = '/market/login.asp';
            },5000);
        },
        error: function (data) {
            $('.wrap_loader').hide();
            if (data.status === 422) {
                var return_data = $.parseJSON(data.responseText);
                var message = return_data['message'];
                var errors = return_data['errors'];
                $.each(errors, function (key, val) {
                    // $("#" + key).next().html(val);
                    toastr.error(val);
                });
            }
        }
    });
});
  
function authorize(email, password, isRemembered) {
    var courses = [];
    if (localStorage.cartData && localStorage.cartData != '') {
        courses = JSON.parse(localStorage.getItem('cartData'));
    }
    var currency = JSON.parse(localStorage.getItem('localization'));
    if (currency) {
        currency = currency.currency;
    }
    // if (!$('#loginForm').valid()) {
    //     return false;
    // }
    var userType = $("#user_type").val();
    $.ajax({
        type: 'POST',
        url: 'login.jsp?v='+timeStamp(),
        dataType: 'JSON',
        cache: false,
        headers: { 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content') },
        data: {
            "user_email": email,
            "user_password": password,
            "currency": currency,
            "courses": courses,
            "remember_me": isRemembered,
            "userType": userType
            // "h-captcha-response":hcaptcha.getResponse()
        },
        beforeSend: function () {
            $('.wrap_loader').show();

        },
        success: function (data, textStatus, xhr) {
            if (xhr.status == 200) {
                toastr.success(xhr.responseJSON.message);
                redirect_url = xhr.responseJSON.redirect_url;
                localStorage.removeItem("cartData");
                localStorage.setItem('isVisited',1);
                x = (document.referrer).split("/");
                createCookie('subscription_purchased', xhr.responseJSON.subscription_purchased, 30);
                if (x[x.length - 1] == "cart.jsp") {
                    window.location.href = document.referrer + "?v="+timeStamp();
                } else {
                    window.location.href = redirect_url;
                }
            } else {
                hcaptcha.reset();
                toastr.error(xhr.responseJSON.message);
            }
        }, complete: function () {
            $('.wrap_loader').hide();
        },
        error: function (reject) {
            if (reject.status == 401) {
                toastr.error(reject.responseJSON.message);
            }
            $('.wrap_loader').hide();
            // hcaptcha.reset();
            var return_data = $.parseJSON(reject.responseText);
            var message = return_data['message'];
            var errors = return_data['errors'];
            $.each(errors, function (key, val) {
                toastr.error(val);
            });
        }
    });
}

function SocialAuthorize(provider, response) {
    var isRemembered = 0;
    var courses = [];
    if (localStorage.cartData && localStorage.cartData != '') {
        courses = JSON.parse(localStorage.getItem('cartData'));
    }
    var currency = JSON.parse(localStorage.getItem('localization'));
    if (currency) {
        currency = currency.currency;
    }

    $.ajax({
        type: 'POST',
        url: 'socialLogin.jsp?v='+timeStamp(),
        dataType: 'JSON',
        cache: false,
        headers: { 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content') },
        data: {
            "provider": provider,
            "resData": response,
            "currency": currency,
            "courses": courses,
            "remember_me": isRemembered,
        },
        beforeSend: function () {
            $('.wrap_loader').show();

        },
        success: function (data, textStatus, xhr) {
            if (xhr.status == 200) {
                toastr.success(xhr.responseJSON.message);
                redirect_url = xhr.responseJSON.redirect_url;
                localStorage.removeItem("cartData");
                x = (document.referrer).split("/");
                createCookie('subscription_purchased', xhr.responseJSON.subscription_purchased, 30);
                if (x[x.length - 1] == "cart.jsp") {
                    window.location.href = document.referrer + "?v="+timeStamp();
                } else {
                    window.location.href = redirect_url;
                }
            } else {
                toastr.error(xhr.responseJSON.message);
            }
        }, complete: function () {
            $('.wrap_loader').hide();
        },
        error: function (reject) {
            $('.wrap_loader').hide();
            // hcaptcha.reset();
            var return_data = $.parseJSON(reject.responseText);
            var message = return_data['message'];
            var errors = return_data['errors'];
            $.each(errors, function (key, val) {
                toastr.error(val);
            });
        }
    });
}

function generateOTP(email, flag = 0) {
    var url = 'sendOTP.jsp?v=' + timeStamp();
    var type = 'signup';
    var userType = $("#user_type").val();
    var data;
    if (flag == 0) {
        data = {
            "email_id": email,
            "type": 'signup',
            "userType": userType,
            "h-captcha-response": hcaptcha.getResponse()
        };
    }
    else if (flag == 1) {
        type = 'forget'
        data = {
            "email_id": email,
            "type": 'forget',
            "h-captcha-response": hcaptcha.getResponse()
        };
    }
    $.ajax({
        type: 'POST',
        url: url,
        dataType: 'JSON',
        cache: false,
        data: data,
        headers: { 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content') },
        beforeSend: function () {
            $('.wrap_loader').show();
        },
        success: function (data) {
            if (flag == 0) {
                $('#divSignup').hide();
                $('#divSignup-2').show();
                $('#txtValidateOTP').focus();
                $('#email_sent').html("OTP sent to <b>" + email + "</b>");
            } else if (flag == 1) {
                $("#divForgot").hide();
                $("#divForgot-2").show();
                $("#txtForgotOTP").focus();
            }
            toastr.success(data.message);

        },
        complete: function () {
            $('.wrap_loader').hide();
        },
        error: function (data) {
            $('.wrap_loader').hide();
            hcaptcha.reset();
            if (data.status === 422) {
                var return_data = $.parseJSON(data.responseText);
                var message = return_data['message'];
                toastr.error(message);
                /* var errors = return_data['errors'];
                $.each(errors, function (key, val) {
                    toastr.error(val);
                }); */
            }
        }
    });
}
function dupgenerateOTP(email, flag = 0) {
    var url = 'dupSignup.jsp?v=' + timeStamp();
    var type = 'signup';
    var data;
    if (flag == 0) {

        data = {
            "email_id": email,
            "type": 'signup',
            "h-captcha-response": hcaptcha.getResponse()
        };
    }
    else if (flag == 1) {
        type = 'forget'
        data = {
            "email_id": email,
            "type": 'forget'
        };
    }
    $.ajax({
        type: 'POST',
        url: url,
        dataType: 'JSON',
        cache: false,
        data: data,
        headers: { 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content') },
        beforeSend: function () {
            $('.wrap_loader').show();
        },
        success: function (data) {
            if (flag == 0) {
                $('#divSignup').hide();
                $('#divSignup-2').show();
                $('#txtValidateOTP').focus();
                $('#email_sent').html("OTP sent to <b>" + email + "</b>");

            } else if (flag == 1) {
                $("#divForgot").hide();
                $("#divForgot-2").show();
                $("#txtForgotOTP").focus();
            }
            toastr.success(data.message);

        },
        complete: function () {
            $('.wrap_loader').hide();

        },
        error: function (data) {
            $('.wrap_loader').hide();
            hcaptcha.reset();
            if (data.status === 422) {
                var return_data = $.parseJSON(data.responseText);
                var message = return_data['message'];
                var errors = return_data['errors'];
                $.each(errors, function (key, val) {
                    if(userType == 'BA' && val == "The email id has already been taken."){
                        val = "Email already exist, Contact Tutorialspoint for Business Sign Up";
                    }
                    toastr.error(val);
                });
            }
        }
    });
}
function validateOTP(otp, email, flag = 0) {
    var url = 'validateOTP.jsp?v=' + timeStamp();
    var type = 'signup'
    if (flag == 1) {
        type = 'forget'
    }
    $.ajax({
        type: 'POST',
        url: url,
        dataType: 'JSON',
        cache: false,

        headers: { 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content') },
        data: {
            "secret_code": otp,
            "email_id": email,
            "type": type
        },
        beforeSend: function () {
            $('.wrap_loader').show();
        },
        success: function (data) {
            $('.wrap_loader').hide();
            if (flag == 0) {
                $('#divSignup-2').hide();
                $('#divSignup-3').show();
                $('#textRegName').focus();
            } else if (flag == 1) {
                $('#divForgot-2').hide();
                $('#divForgot-3').show();
                $('#txtNewPassword').focus();
            }
            toastr.success(data.message);
        },
        error: function (data) {
            $('.wrap_loader').hide();
            var return_data = $.parseJSON(data.responseText);
            var message = return_data['message'];
            var errors = return_data['errors'];
            $("#txtValidateOTP").val('');
            $("#txtValidateOTP").focus();
            $.each(errors, function (key, val) {
                toastr.error(val);
            });

        }
    });
}
function submitUserDetails(otp, email, passwd, name, mailing, userType = 'U') {
    $.ajax({
        type: 'POST',
        url: 'register.jsp?v=' + timeStamp(),
        dataType: 'JSON',
        headers: { 'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content') },
        cache: false,
        textSRegPwd: {
            required: true,
            minlength: 6,
            maxlength: 18, // here
            
        },
        data: {
            "secret_code": otp,
            "email_id": email,
            "newpass": passwd,
            "user_name": name,
            "return_url": "",
            "mailing": mailing,
            "userType": userType
        },
        beforeSend: function () {
            $('.wrap_loader').show();
        },
        success: function (data) {
            $('.wrap_loader').hide();
            window.location.href = data.url;
            toastr.success(data.message);
        },
        error: function (data) {
            $('.wrap_loader').hide();
            var return_data = $.parseJSON(data.responseText);
            var message = return_data['message'];
            var errors = return_data['errors'];
            $.each(errors, function (key, val) {
                toastr.error(val);
            });

        }
    });

}
function createCookie(name, value, days) {
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        var expires = "; expires=" + date.toGMTString();
    }
    else var expires = "";
    document.cookie = name + "=" + value + expires + "; path=/";
}

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ')
            c = c.substring(1);
        if (c.indexOf(name) == 0)
            return c.substring(name.length, c.length);
    }
    return "";
}